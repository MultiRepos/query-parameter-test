<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query Parameter Ultimate</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --text-color: #333;
            --accent-color: #3498db;
            --container-bg: white;
            --output-bg: #eef;
            --output-border: #ccf;
            --font-family: Arial, sans-serif;
            --font-size: 16px;
            --padding: 20px;
            --border: 1px solid #ddd;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --transition: all 0.4s ease;
        }
        .theme-dark{--bg-color:#1a1a1a;--text-color:#f0f0f0;--container-bg:#2d2d2d;--output-bg:#3a3a3a;--output-border:#555;}
        .font-mono{--font-family:'Courier New',monospace;}
        .size-small{--font-size:14px;--padding:12px;}
        .size-large{--font-size:18px;--padding:28px;}
        .no-border{--border:none;}
        .no-shadow{--shadow:none;}
        .layout-grid{display:grid;grid-template-columns:1fr;gap:20px;}
        .layout-card{max-width:420px;margin:40px auto;}
        .layout-list{max-width:800px;}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideIn{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
        .animate-fade{animation:fadeIn .6s ease-out;}
        .animate-slide{animation:slideIn .6s ease-out;}
        body{font-family:var(--font-family);margin:0;background:var(--bg-color);color:var(--text-color);font-size:var(--font-size);transition:var(--transition);min-height:100vh;}
        .container{max-width:600px;margin:40px auto;padding:var(--padding);background:var(--container-bg);border:var(--border);border-radius:8px;box-shadow:var(--shadow);transition:var(--transition);}
        h1{color:var(--accent-color);margin-top:0;font-size:2em;}
        #output{margin-top:20px;padding:15px;background:var(--output-bg);border:1px solid var(--output-border);border-radius:4px;font-family:monospace;line-height:1.6;}
        form{margin-top:20px;}
        input[type=text]{width:68%;padding:8px;margin-right:10px;border:1px solid #ccc;border-radius:4px;font-family:inherit;font-size:.95em;}
        button{padding:8px 16px;background:var(--accent-color);color:#fff;border:none;border-radius:4px;cursor:pointer;font-family:inherit;transition:.2s;}
        button:hover{opacity:.9;}
        .example{margin:15px 0;font-size:.9em;color:#666;}
        .example code{background:#eee;padding:2px 6px;border-radius:3px;font-family:monospace;}
        .debug-panel{margin-top:20px;padding:12px;background:#fff3cd;border:1px solid #ffeaa7;border-radius:4px;font-family:monospace;font-size:.8em;display:none;}
        .hidden{display:none !important;}
        .greeting{font-size:1.3em;margin:10px 0;color:var(--accent-color);font-weight:bold;}
        .preset-section{margin-top:20px;}
        .preset-input{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;}
        .preset-input input{flex:1;min-width:120px;}
        .preset-list{margin-top:8px;}
        .preset-item{
            display:flex;justify-content:space-between;align-items:center;
            padding:8px 12px;background:var(--output-bg);border:1px solid var(--output-border);
            border-radius:4px;margin-bottom:6px;font-size:0.9em;
        }
        .preset-item button{
            padding:4px 8px;font-size:0.8em;margin-left:4px;border-radius:4px;
        }
        .preset-item .load-btn{
            background:#27ae60;color:white;
        }
        .preset-item .delete-btn{
            background:#e74c3c;color:white;width:28px;height:28px;
            padding:0;display:flex;align-items:center;justify-content:center;
            font-size:1em;line-height:1;
        }
        .preset-item .delete-btn::before{
            content:"Delete";
            font-size:12px;
        }
        .qr-section{margin-top:20px;text-align:center;}
        #qrCanvas{display:block;margin:10px auto;max-width:200px;border:2px solid var(--output-border);border-radius:6px;background:white;}
    </style>
</head>
<body>
<div class="container" id="mainContainer">
    <h1 id="pageTitle">Query Parameter Ultimate</h1>
    <div id="greeting" class="greeting hidden"></div>
    <p id="description">All styling, content, and behaviour are driven by URL query parameters.</p>

    <div class="example">
        <strong>Try:</strong><br>
        <code>theme=dark&amp;layout=card&amp;lang=es&amp;size=large</code>
    </div>

    <div id="output">
        <strong>Active Settings:</strong><br><span id="params">Loading…</span>
    </div>

    <form id="queryForm">
        <input type="text" id="queryInput" placeholder="e.g. theme=dark&amp;layout=card">
        <button type="submit">Apply</button>
    </form>

    <!-- ==== PRESETS ==== -->
    <div class="preset-section">
        <div class="preset-input">
            <input type="text" id="presetName" placeholder="Preset name">
            <button id="savePreset">Save Preset</button>
        </div>
        <div id="presetList" class="preset-list"></div>
    </div>

    <!-- ==== EXPORT / QR ==== -->
    <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;">
        <button id="exportJson">Export JSON</button>
        <button id="showQr">Show QR Code</button>
    </div>
    <div class="qr-section hidden" id="qrSection">
        <canvas id="qrCanvas" width="200" height="200"></canvas>
        <p><small>Scan to open this exact configuration on another device.</small></p>
    </div>

    <div id="debugPanel" class="debug-panel"></div>

    <p><small>All changes are client-side – share the URL!</small></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
/* ---------- Core Elements ---------- */
const els = {
    params: document.getElementById('params'),
    title: document.getElementById('pageTitle'),
    desc: document.getElementById('description'),
    greeting: document.getElementById('greeting'),
    container: document.getElementById('mainContainer'),
    debug: document.getElementById('debugPanel'),
    queryForm: document.getElementById('queryForm'),
    queryInput: document.getElementById('queryInput'),
    presetName: document.getElementById('presetName'),
    savePreset: document.getElementById('savePreset'),
    presetList: document.getElementById('presetList'),
    exportJson: document.getElementById('exportJson'),
    showQr: document.getElementById('showQr'),
    qrSection: document.getElementById('qrSection'),
    qrCanvas: document.getElementById('qrCanvas')
};
const root = document.documentElement;
const body = document.body;

/* ---------- Translations ---------- */
const i18n = {
    en:{title:"Query Parameter Ultimate",desc:"All styling, content, and behaviour are driven by URL query parameters.",greeting:"Welcome!"},
    es:{title:"Parámetros Ultimate",desc:"¡Todo el estilo, contenido y comportamiento se controla mediante parámetros de URL!",greeting:"¡Bienvenido!"},
    fr:{title:"Paramètres Ultimate",desc:"Tout le style, le contenu et le comportement sont pilotés par les paramètres d’URL.",greeting:"Bienvenue !"}
};

/* ---------- Apply Parameters ---------- */
function apply(params){
    body.className = '';
    els.container.className = 'container';
    els.debug.style.display='none';
    els.greeting.classList.add('hidden');
    let applied = [];

    const lang = params.get('lang')||'en';
    const t = i18n[lang]||i18n.en;
    els.title.textContent = params.get('title')||t.title;
    document.title = els.title.textContent;
    els.desc.textContent = t.desc;

    const greet = params.get('greeting');
    if(greet){
        els.greeting.textContent = decodeURIComponent(greet.replace(/\+/g,' '));
        applied.push(`greeting: "${els.greeting.textContent}"`);
    }else{
        els.greeting.textContent = t.greeting;
    }
    els.greeting.classList.remove('hidden');

    if(params.get('theme')==='dark'){body.classList.add('theme-dark');applied.push('theme: dark');}
    else if(params.get('theme')==='light') applied.push('theme: light');

    if(params.get('font')==='mono'){body.classList.add('font-mono');applied.push('font: monospace');}

    if(params.get('size')==='small'){body.classList.add('size-small');applied.push('size: small');}
    else if(params.get('size')==='large'){body.classList.add('size-large');applied.push('size: large');}

    const layout = params.get('layout');
    if(['grid','card','list'].includes(layout)){
        els.container.classList.add(`layout-${layout}`);
        applied.push(`layout: ${layout}`);
    }

    if(params.get('border')==='0'){body.classList.add('no-border');applied.push('border: off');}
    if(params.get('shadow')==='0'){body.classList.add('no-shadow');applied.push('shadow: off');}

    const anim = params.get('animation');
    if(anim==='fade'){els.container.classList.add('animate-fade');applied.push('animation: fade');}
    else if(anim==='slide'){els.container.classList.add('animate-slide');applied.push('animation: slide');}

    const hide = params.get('hide');
    if(hide==='title') els.title.classList.add('hidden');
    if(hide==='form') els.queryForm.classList.add('hidden');

    const bg = params.get('bgcolor');
    if(bg && /^#[0-9A-Fa-f]{6}$/i.test(bg)){root.style.setProperty('--bg-color',bg);applied.push(`bgcolor: ${bg}`);}
    const ac = params.get('accent');
    if(ac && /^#[0-9A-Fa-f]{6}$/i.test(ac)){root.style.setProperty('--accent-color',ac);applied.push(`accent: ${ac}`);}

    if(params.get('debug')==='1'){
        els.debug.style.display='block';
        els.debug.innerHTML=`<strong>Debug:</strong><br>URL: ${location.href}<br>UA: ${navigator.userAgent.split(' ').slice(0,3).join(' ')}…`;
        applied.push('debug: on');
    }

    els.params.innerHTML = applied.length ? applied.join('<br>') : 'Default settings';
    if(params.toString()){
        els.params.innerHTML += `<br><br><small><strong>All params:</strong> ${Array.from(params).map(p=>p.join('=')).join(', ')}</small>`;
    }
}

/* ---------- URL Handling ---------- */
function updateFromURL(){
    const p = new URLSearchParams(location.search);
    apply(p);
    renderPresetList();
}
window.onload = updateFromURL;
window.onpopstate = updateFromURL;

els.queryForm.addEventListener('submit',e=>{
    e.preventDefault();
    const input = els.queryInput.value.trim();
    const base = location.href.split('?')[0];
    const url = input ? `${base}?${input}` : base;
    history.pushState({},"",url);
    updateFromURL();
});

/* ---------- Presets (localStorage) ---------- */
const STORAGE_KEY = 'queryParamPresets';
function getPresets(){return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');}
function savePresets(obj){localStorage.setItem(STORAGE_KEY,JSON.stringify(obj));}

function renderPresetList(){
    const presets = getPresets();
    const list = els.presetList;
    list.innerHTML = '';
    if(Object.keys(presets).length === 0){
        list.innerHTML = '<em style="color:#999;font-size:0.9em;">No presets saved yet.</em>';
        return;
    }
    Object.keys(presets).sort().forEach(name => {
        const qs = presets[name];
        const item = document.createElement('div');
        item.className = 'preset-item';
        item.innerHTML = `
            <span title="Click Load to apply"><strong>${name}</strong></span>
            <div>
                <button class="load-btn" title="Load preset">Load</button>
                <button class="delete-btn" title="Delete preset">Delete</button>
            </div>
        `;
        const loadBtn = item.querySelector('.load-btn');
        const delBtn = item.querySelector('.delete-btn');
        loadBtn.onclick = () => {
            const base = location.href.split('?')[0];
            history.pushState({},"", qs ? `${base}?${qs}` : base);
            updateFromURL();
        };
        delBtn.onclick = () => {
            if(confirm(`Delete preset "${name}"?`)){
                delete presets[name];
                savePresets(presets);
                renderPresetList();
            }
        };
        list.appendChild(item);
    });
}

els.savePreset.addEventListener('click',()=>{
    const name = els.presetName.value.trim();
    if(!name) return alert('Enter a preset name');
    const presets = getPresets();
    if(Object.keys(presets).length >= 10) return alert('Max 10 presets allowed');
    if(presets[name]) return alert(`Preset "${name}" already exists`);
    presets[name] = location.search.substring(1);
    savePresets(presets);
    els.presetName.value = '';
    renderPresetList();
    alert(`Preset "${name}" saved!`);
});

/* ---------- Export JSON ---------- */
els.exportJson.addEventListener('click',()=>{
    const params = new URLSearchParams(location.search);
    const obj = {};
    for(const [k,v] of params) obj[k]=v;
    const data = JSON.stringify(obj,null,2);
    const blob = new Blob([data],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='query-config.json';
    a.click();
    URL.revokeObjectURL(url);
});

/* ---------- QR Code (FIXED) ---------- */
els.showQr.addEventListener('click',()=>{
    const wasHidden = els.qrSection.classList.contains('hidden');
    els.qrSection.classList.toggle('hidden');
    
    if (wasHidden) {
        // Clear canvas first
        const ctx = els.qrCanvas.getContext('2d');
        ctx.clearRect(0, 0, 200, 200);
        
        // Generate QR with proper colors
        const isDark = getComputedStyle(body).getPropertyValue('--bg-color').trim() === '#1a1a1a';
        QRCode.toCanvas(els.qrCanvas, location.href, {
            width: 200,
            margin: 2,
            color: {
                dark: isDark ? '#f0f0f0' : '#000000',
                light: isDark ? '#2d2d2d' : '#ffffff'
            }
        }, err => {
            if (err) console.error('QR Error:', err);
        });
    }
});

/* ---------- Init ---------- */
renderPresetList();
</script>
</body>
</html>
